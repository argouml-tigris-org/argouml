<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UMLActivityDiagram.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">argouml-app</a> &gt; <a href="index.source.html" class="el_package">org.argouml.uml.diagram.activity.ui</a> &gt; <span class="el_source">UMLActivityDiagram.java</span></div><h1>UMLActivityDiagram.java</h1><pre class="source lang-java linenums">/* $Id$
 *****************************************************************************
 * Copyright (c) 2009-2012 Contributors - see below
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    bobtarling
 *****************************************************************************
 *
 * Some portions of this file was previously release using the BSD License:
 */

// Copyright (c) 1996-2008 The Regents of the University of California. All
// Rights Reserved. Permission to use, copy, modify, and distribute this
// software and its documentation without fee, and without a written
// agreement is hereby granted, provided that the above copyright notice
// and this paragraph appear in all copies.  This software program and
// documentation are copyrighted by The Regents of the University of
// California. The software program and documentation are supplied &quot;AS
// IS&quot;, without any accompanying services from The Regents. The Regents
// does not warrant that the operation of the program will be
// uninterrupted or error-free. The end-user understands that the program
// was developed for research purposes and is advised not to rely
// exclusively on the program for any reason.  IN NO EVENT SHALL THE
// UNIVERSITY OF CALIFORNIA BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT,
// SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING LOST PROFITS,
// ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF
// THE UNIVERSITY OF CALIFORNIA HAS BEEN ADVISED OF THE POSSIBILITY OF
// SUCH DAMAGE. THE UNIVERSITY OF CALIFORNIA SPECIFICALLY DISCLAIMS ANY
// WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
// MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE SOFTWARE
// PROVIDED HEREUNDER IS ON AN &quot;AS IS&quot; BASIS, AND THE UNIVERSITY OF
// CALIFORNIA HAS NO OBLIGATIONS TO PROVIDE MAINTENANCE, SUPPORT,
// UPDATES, ENHANCEMENTS, OR MODIFICATIONS.

package org.argouml.uml.diagram.activity.ui;

import java.awt.Rectangle;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyVetoException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.swing.Action;

import org.argouml.i18n.Translator;
import org.argouml.model.ActivityDiagram;
import org.argouml.model.ActivityGraphsHelper;
import org.argouml.model.DeleteInstanceEvent;
import org.argouml.model.Model;
import org.argouml.ui.CmdCreateNode;
import org.argouml.uml.diagram.DiagramElement;
import org.argouml.uml.diagram.DiagramSettings;
import org.argouml.uml.diagram.UMLMutableGraphSupport;
import org.argouml.uml.diagram.activity.ActivityDiagramGraphModel;
import org.argouml.uml.diagram.state.StateDiagramGraphModel;
import org.argouml.uml.diagram.state.ui.ActionCreatePseudostate;
import org.argouml.uml.diagram.state.ui.ButtonActionNewCallEvent;
import org.argouml.uml.diagram.state.ui.ButtonActionNewChangeEvent;
import org.argouml.uml.diagram.state.ui.ButtonActionNewSignalEvent;
import org.argouml.uml.diagram.state.ui.ButtonActionNewTimeEvent;
import org.argouml.uml.diagram.state.ui.FigBranchState;
import org.argouml.uml.diagram.state.ui.FigFinalState;
import org.argouml.uml.diagram.state.ui.FigForkState;
import org.argouml.uml.diagram.state.ui.FigInitialState;
import org.argouml.uml.diagram.state.ui.FigJoinState;
import org.argouml.uml.diagram.state.ui.FigJunctionState;
import org.argouml.uml.diagram.state.ui.FigStateVertex;
import org.argouml.uml.diagram.static_structure.ui.FigComment;
import org.argouml.uml.diagram.ui.ActionSetMode;
import org.argouml.uml.diagram.ui.FigNodeModelElement;
import org.argouml.uml.diagram.ui.RadioAction;
import org.argouml.uml.diagram.ui.UMLDiagram;
import org.argouml.uml.ui.behavior.common_behavior.ActionNewActionSequence;
import org.argouml.uml.ui.behavior.common_behavior.ActionNewCallAction;
import org.argouml.uml.ui.behavior.common_behavior.ActionNewCreateAction;
import org.argouml.uml.ui.behavior.common_behavior.ActionNewDestroyAction;
import org.argouml.uml.ui.behavior.common_behavior.ActionNewReturnAction;
import org.argouml.uml.ui.behavior.common_behavior.ActionNewSendAction;
import org.argouml.uml.ui.behavior.common_behavior.ActionNewTerminateAction;
import org.argouml.uml.ui.behavior.common_behavior.ActionNewUninterpretedAction;
import org.argouml.uml.ui.behavior.state_machines.ButtonActionNewGuard;
import org.argouml.util.ToolBarUtility;
import org.tigris.gef.base.LayerPerspective;
import org.tigris.gef.base.LayerPerspectiveMutable;
import org.tigris.gef.base.ModeCreatePolyEdge;
import org.tigris.gef.graph.GraphModel;
import org.tigris.gef.presentation.Fig;
import org.tigris.gef.presentation.FigNode;

/**
 * The Activity diagram.&lt;p&gt;
 *
 * TODO: Finish the work on subactivity states.
 */
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">public class UMLActivityDiagram extends UMLDiagram implements ActivityDiagram {</span>

    /**
     * Logger.
     */
<span class="fc" id="L111">    private static final Logger LOG =</span>
<span class="fc" id="L112">        Logger.getLogger(UMLActivityDiagram.class.getName());</span>

    /**
     * The UID.
     */
    private static final long serialVersionUID = 6223128918989919230L;

    /**
     * this diagram needs to be deleted when its statemachine is deleted.
     */
    private Object theActivityGraph;

    private Action actionState;
    private Action actionStartPseudoState;
    private Action actionFinalPseudoState;
    private Action actionJunctionPseudoState;
    private Action actionForkPseudoState;
    private Action actionJoinPseudoState;
    private Action actionTransition;
    private Action actionObjectFlowState;
    private Action actionSwimlane;
    private Action actionCallState;
    private Action actionSubactivityState;
    private Action actionCallEvent;
    private Action actionChangeEvent;
    private Action actionSignalEvent;
    private Action actionTimeEvent;
    private Action actionGuard;
    private Action actionCallAction;
    private Action actionCreateAction;
    private Action actionDestroyAction;
    private Action actionReturnAction;
    private Action actionSendAction;
    private Action actionTerminateAction;
    private Action actionUninterpretedAction;
    private Action actionActionSequence;

    /**
     * Constructor.
     *
     * @deprecated for 0.28 by tfmorris.  Use
     * {@link #UMLActivityDiagram(String, Object, GraphModel)}.
     */
    @Deprecated
    public UMLActivityDiagram() {
<span class="fc" id="L157">        super();</span>
        try {
<span class="fc" id="L159">            setName(getNewDiagramName());</span>
<span class="nc" id="L160">        } catch (PropertyVetoException pve) {</span>
            // no action required in case of veto on setName
<span class="fc" id="L162">        }</span>
        // TODO: All super constructors should take a GraphModel
<span class="fc" id="L164">        setGraphModel(createGraphModel());</span>
<span class="fc" id="L165">    }</span>

    /**
     * Constructor.
     *
     * @param namespace the namespace for the diagram
     * @param agraph the ActivityGraph for the diagram
     * @deprecated for 0.28 by tfmorris.  Use
     * {@link #UMLActivityDiagram(String, Object, GraphModel)}.
     */
    @Deprecated
    public UMLActivityDiagram(Object namespace, Object agraph) {

<span class="fc" id="L178">        this();</span>

<span class="fc bfc" id="L180" title="All 2 branches covered.">        if (namespace == null) {</span>
<span class="fc" id="L181">            namespace = Model.getFacade().getNamespace(agraph);</span>
        }

<span class="pc bpc" id="L184" title="1 of 2 branches missed.">        if (!Model.getFacade().isANamespace(namespace)</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">            || !Model.getFacade().isAActivityGraph(agraph)) {</span>
<span class="nc" id="L186">            throw new IllegalArgumentException();</span>
        }

<span class="fc bfc" id="L189" title="All 2 branches covered.">        if (Model.getFacade().getName(namespace) != null) {</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">            if (!Model.getFacade().getName(namespace).trim().equals(&quot;&quot;)) {</span>
<span class="fc" id="L191">                String name =</span>
<span class="fc" id="L192">                    Model.getFacade().getName(namespace)</span>
                    + &quot; activity &quot;
<span class="fc" id="L194">                    + (Model.getFacade().getBehaviors(namespace).size());</span>
                try {
<span class="fc" id="L196">                    setName(name);</span>
<span class="nc" id="L197">                } catch (PropertyVetoException pve) {</span>
                    // no action required
<span class="fc" id="L199">                }</span>
            }
        }
<span class="fc" id="L202">        setup(namespace, agraph);</span>
<span class="fc" id="L203">    }</span>

    /*
     * @see org.tigris.gef.base.Diagram#initialize(java.lang.Object)
     */
    public void initialize(Object o) {
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (!(Model.getFacade().isAActivityGraph(o))) {</span>
<span class="nc" id="L210">            return;</span>
        }
<span class="fc" id="L212">        Object context = Model.getFacade().getContext(o);</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        if (context != null) {</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">            if (Model.getFacade().isABehavioralFeature(context)) {</span>
<span class="nc" id="L215">                setup(Model.getFacade().getNamespace(</span>
<span class="nc" id="L216">                                Model.getFacade().getOwner(context)), o);</span>
            } else {
<span class="fc" id="L218">                setup(context, o);</span>
            }
        } else {
<span class="nc" id="L221">            Object namespace4Diagram = Model.getFacade().getNamespace(o);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (namespace4Diagram != null) {</span>
<span class="nc" id="L223">                setup(namespace4Diagram, o);</span>
            } else {
<span class="nc" id="L225">                throw new IllegalStateException(&quot;Cannot find context &quot;</span>
                        + &quot;nor namespace while initializing activity diagram&quot;);
            }
        }
<span class="fc" id="L229">    }</span>

    /**
     * Method to perform a number of important initializations of an
     * &lt;em&gt;Activity Diagram&lt;/em&gt;.&lt;p&gt;
     *
     * Each diagram type has a similar &lt;em&gt;UMLxxxDiagram&lt;/em&gt; class.&lt;p&gt;
     *
     * Changed &lt;em&gt;lay&lt;/em&gt; from &lt;em&gt;LayerPerspective&lt;/em&gt; to
     * &lt;em&gt;LayerPerspectiveMutable&lt;/em&gt;.  This class is a child of
     * &lt;em&gt;LayerPerspective&lt;/em&gt; and was implemented to correct some
     * difficulties in changing the model. &lt;em&gt;lay&lt;/em&gt; is used mainly
     * in &lt;em&gt;LayerManager&lt;/em&gt;(GEF) to control the adding, changing and
     * deleting layers on the diagram...  psager@tigris.org Jan. 24,
     * 2002

     * @param namespace  Namespace from the model
     * @param agraph ActivityGraph from the model
     */
    public void setup(Object namespace, Object agraph) {
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        if (!Model.getFacade().isANamespace(namespace)</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">            || !Model.getFacade().isAActivityGraph(agraph)) {</span>
<span class="nc" id="L251">            throw new IllegalArgumentException();</span>
        }

<span class="fc" id="L254">        setNamespace(namespace);</span>

<span class="fc" id="L256">        theActivityGraph = agraph;</span>


<span class="fc" id="L259">        ActivityDiagramGraphModel gm = createGraphModel();</span>

<span class="fc" id="L261">        gm.setHomeModel(namespace);</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">        if (theActivityGraph != null) {</span>
<span class="fc" id="L263">            gm.setMachine(theActivityGraph);</span>
        }
<span class="fc" id="L265">        ActivityDiagramRenderer rend = new ActivityDiagramRenderer();</span>

<span class="fc" id="L267">        LayerPerspective lay = new LayerPerspectiveMutable(</span>
<span class="fc" id="L268">                Model.getFacade().getName(namespace), gm);</span>
<span class="fc" id="L269">        lay.setGraphNodeRenderer(rend);</span>
<span class="fc" id="L270">        lay.setGraphEdgeRenderer(rend);</span>
<span class="fc" id="L271">        setLayer(lay);</span>

        /* Listen to activitygraph deletion,
         * delete this diagram. */
<span class="fc" id="L275">        Model.getPump().addModelEventListener(this, theActivityGraph,</span>
                new String[] {&quot;remove&quot;, &quot;namespace&quot;});
<span class="fc" id="L277">    }</span>

    // TODO: Needs to be tidied up after stable release. Graph model
    // should be created in constructor
    private ActivityDiagramGraphModel createGraphModel() {
<span class="fc bfc" id="L282" title="All 2 branches covered.">	if ((getGraphModel() instanceof ActivityDiagramGraphModel)) {</span>
<span class="fc" id="L283">	    return (ActivityDiagramGraphModel) getGraphModel();</span>
	} else {
<span class="fc" id="L285">	    return new ActivityDiagramGraphModel();</span>
	}
    }

    /*
     * @see org.argouml.uml.diagram.ui.UMLDiagram#propertyChange(java.beans.PropertyChangeEvent)
     */
    public void propertyChange(PropertyChangeEvent evt) {
<span class="fc bfc" id="L293" title="All 4 branches covered.">        if ((evt.getSource() == theActivityGraph)</span>
                &amp;&amp; (evt instanceof DeleteInstanceEvent)
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">                &amp;&amp; &quot;remove&quot;.equals(evt.getPropertyName())) {</span>
<span class="fc" id="L296">            Model.getPump().removeModelEventListener(this,</span>
                    theActivityGraph, new String[] {&quot;remove&quot;, &quot;namespace&quot;});
<span class="fc" id="L298">            getProject().moveToTrash(this);</span>
        }
<span class="fc bfc" id="L300" title="All 2 branches covered.">        if (evt.getSource() == getStateMachine()) {</span>
            Object newNamespace =
<span class="fc" id="L302">                Model.getFacade().getNamespace(getStateMachine());</span>
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">            if (getNamespace() != newNamespace) {</span>
                /* The namespace of the activitygraph is changed! */
<span class="nc" id="L305">                setNamespace(newNamespace);</span>
<span class="nc" id="L306">                ((UMLMutableGraphSupport) getGraphModel())</span>
<span class="nc" id="L307">                                .setHomeModel(newNamespace);</span>
            }
        }
<span class="fc" id="L310">    }</span>

    /*
     * @see org.argouml.uml.diagram.ui.UMLDiagram#getOwner()
     */
    public Object getOwner() {
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (!(getGraphModel() instanceof ActivityDiagramGraphModel)) {</span>
<span class="nc" id="L317">            throw new IllegalStateException(</span>
                    &quot;Incorrect graph model of &quot;
<span class="nc" id="L319">                    + getGraphModel().getClass().getName());</span>
        }
<span class="nc" id="L321">        ActivityDiagramGraphModel gm =</span>
<span class="nc" id="L322">            (ActivityDiagramGraphModel) getGraphModel();</span>
<span class="nc" id="L323">        return gm.getMachine();</span>
    }

    /**
     * @return the statemachine
     *
     * TODO: If this method is called by any of the Figs, it will introduce
     * a dependency cycle.  It would be much better if they could just
     * use {@link org.argouml.uml.diagram.ArgoDiagram#getOwner()} which does
     * the same thing.
     */
    public Object getStateMachine() {
<span class="fc" id="L335">        GraphModel gm = getGraphModel();</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">        if (gm instanceof StateDiagramGraphModel) {</span>
<span class="fc" id="L337">            Object machine = ((StateDiagramGraphModel) gm).getMachine();</span>
<span class="fc bfc" id="L338" title="All 2 branches covered.">            if (!Model.getUmlFactory().isRemoved(machine)) {</span>
<span class="fc" id="L339">                return machine;</span>
            }
        }
<span class="fc" id="L342">        return null;</span>
    }

    /**
     * @param sm set the statemachine for this diagram
     */
    public void setStateMachine(Object sm) {

<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (!Model.getFacade().isAStateMachine(sm)) {</span>
<span class="nc" id="L351">            throw new IllegalArgumentException();</span>
        }

<span class="nc" id="L354">        ((ActivityDiagramGraphModel) getGraphModel()).setMachine(sm);</span>
<span class="nc" id="L355">    }</span>

    /**
     * Get the actions from which to create a toolbar or equivalent
     * graphic triggers.
     *
     * @see org.argouml.uml.diagram.ui.UMLDiagram#getUmlActions()
     * @return the array of actions
     */
    protected Object[] getUmlActions() {
<span class="nc" id="L365">        Object[] actions =</span>
        {
<span class="nc" id="L367">            getActionState(),</span>
<span class="nc" id="L368">            getActionTransition(),</span>
	    null,
<span class="nc" id="L370">	    getActionStartPseudoState(),</span>
<span class="nc" id="L371">	    getActionFinalPseudoState(),</span>
<span class="nc" id="L372">	    getActionJunctionPseudoState(),</span>
<span class="nc" id="L373">	    getActionForkPseudoState(),</span>
<span class="nc" id="L374">	    getActionJoinPseudoState(),</span>
<span class="nc" id="L375">	    getActionSwimlane(),</span>
	    null,
<span class="nc" id="L377">	    getActionCallState(),</span>
<span class="nc" id="L378">            getActionObjectFlowState(),</span>
            /*getActionSubactivityState()*/
            null,
<span class="nc" id="L381">            getTriggerActions(),</span>
<span class="nc" id="L382">            getActionGuard(),</span>
<span class="nc" id="L383">            getEffectActions(),</span>
	};
<span class="nc" id="L385">        return actions;</span>
    }

    protected Object[] getTriggerActions() {
<span class="nc" id="L389">        Object[] actions = {</span>
<span class="nc" id="L390">            getActionCallEvent(),</span>
<span class="nc" id="L391">            getActionChangeEvent(),</span>
<span class="nc" id="L392">            getActionSignalEvent(),</span>
<span class="nc" id="L393">            getActionTimeEvent(),</span>
        };
<span class="nc" id="L395">        ToolBarUtility.manageDefault(actions, &quot;diagram.activity.trigger&quot;);</span>
<span class="nc" id="L396">        return actions;</span>
    }

    protected Object[] getEffectActions() {
<span class="nc" id="L400">        Object[] actions = {</span>
<span class="nc" id="L401">            getActionCallAction(),</span>
<span class="nc" id="L402">            getActionCreateAction(),</span>
<span class="nc" id="L403">            getActionDestroyAction(),</span>
<span class="nc" id="L404">            getActionReturnAction(),</span>
<span class="nc" id="L405">            getActionSendAction(),</span>
<span class="nc" id="L406">            getActionTerminateAction(),</span>
<span class="nc" id="L407">            getActionUninterpretedAction(),</span>
<span class="nc" id="L408">            getActionActionSequence(),</span>
        };
<span class="nc" id="L410">        ToolBarUtility.manageDefault(actions, &quot;diagram.activity.effect&quot;);</span>
<span class="nc" id="L411">        return actions;</span>
    }

    /*
     * @see org.argouml.uml.diagram.ui.UMLDiagram#getLabelName()
     */
    public String getLabelName() {
<span class="fc" id="L418">        return Translator.localize(&quot;label.activity-diagram&quot;);</span>
    }

    /**
     * @return Returns the actionCallState.
     */
    protected Action getActionCallState() {
<span class="nc bnc" id="L425" title="All 2 branches missed.">        if (actionCallState == null) {</span>
<span class="nc" id="L426">            actionCallState =</span>
                new RadioAction(
                        new CmdCreateNode(
<span class="nc" id="L429">                                Model.getMetaTypes().getCallState(),</span>
                                &quot;button.new-callstate&quot;));
        }
<span class="nc" id="L432">        return actionCallState;</span>
    }
    /**
     * @return Returns the actionFinalPseudoState.
     */
    protected Action getActionFinalPseudoState() {
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (actionFinalPseudoState == null) {</span>
<span class="nc" id="L439">            actionFinalPseudoState =</span>
                new RadioAction(
                        new CmdCreateNode(
<span class="nc" id="L442">                                Model.getMetaTypes().getFinalState(),</span>
                        	&quot;button.new-finalstate&quot;));
        }
<span class="nc" id="L445">        return actionFinalPseudoState;</span>
    }
    /**
     * @return Returns the actionForkPseudoState.
     */
    protected Action getActionForkPseudoState() {
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (actionForkPseudoState == null) {</span>
<span class="nc" id="L452">            actionForkPseudoState =</span>
                new RadioAction(
                        new ActionCreatePseudostate(
<span class="nc" id="L455">                                Model.getPseudostateKind().getFork(),</span>
                        	&quot;button.new-fork&quot;));
        }
<span class="nc" id="L458">        return actionForkPseudoState;</span>
    }
    /**
     * @return Returns the actionJoinPseudoState.
     */
    protected Action getActionJoinPseudoState() {
<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (actionJoinPseudoState == null) {</span>
<span class="nc" id="L465">            actionJoinPseudoState =</span>
                new RadioAction(
                        new ActionCreatePseudostate(
<span class="nc" id="L468">                                Model.getPseudostateKind().getJoin(),</span>
                        	&quot;button.new-join&quot;));
        }
<span class="nc" id="L471">        return actionJoinPseudoState;</span>
    }
    /**
     * @return Returns the actionJunctionPseudoState.
     */
    protected Action getActionJunctionPseudoState() {
<span class="nc bnc" id="L477" title="All 2 branches missed.">        if (actionJunctionPseudoState == null) {</span>
<span class="nc" id="L478">            actionJunctionPseudoState =</span>
                new RadioAction(
                        new ActionCreatePseudostate(
<span class="nc" id="L481">                                Model.getPseudostateKind().getJunction(),</span>
                                &quot;button.new-junction&quot;));
        }
<span class="nc" id="L484">        return actionJunctionPseudoState;</span>
    }
    /**
     * @return Returns the actionSwimlane.
     */
    protected Action getActionSwimlane() {
<span class="nc bnc" id="L490" title="All 2 branches missed.">        if (actionSwimlane == null) {</span>
<span class="nc" id="L491">            actionSwimlane =</span>
<span class="nc" id="L492">                new ActionCreatePartition(getStateMachine());</span>
        }
<span class="nc" id="L494">        return actionSwimlane;</span>
    }
    /**
     * @return Returns the actionObjectFlowState.
     */
    protected Action getActionObjectFlowState() {
<span class="nc bnc" id="L500" title="All 2 branches missed.">        if (actionObjectFlowState == null) {</span>
<span class="nc" id="L501">            actionObjectFlowState =</span>
                new RadioAction(
                        new CmdCreateNode(
<span class="nc" id="L504">                                Model.getMetaTypes().getObjectFlowState(),</span>
                                &quot;button.new-objectflowstate&quot;));
        }
<span class="nc" id="L507">        return actionObjectFlowState;</span>
    }
    /**
     * @return Returns the actionStartPseudoState.
     */
    protected Action getActionStartPseudoState() {
<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (actionStartPseudoState == null) {</span>
<span class="nc" id="L514">            actionStartPseudoState =</span>
                new RadioAction(
                        new ActionCreatePseudostate(
<span class="nc" id="L517">                                Model.getPseudostateKind().getInitial(),</span>
                                &quot;button.new-initial&quot;));
        }
<span class="nc" id="L520">        return actionStartPseudoState;</span>
    }
    /**
     * @return Returns the actionState.
     */
    protected Action getActionState() {
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (actionState == null) {</span>
<span class="nc" id="L527">            actionState =</span>
                new RadioAction(
                        new CmdCreateNode(
<span class="nc" id="L530">                                Model.getMetaTypes().getActionState(),</span>
                        	&quot;button.new-actionstate&quot;));
        }
<span class="nc" id="L533">        return actionState;</span>
    }
    /**
     * @return Returns the actionSubactivityState.
     */
    protected Action getActionSubactivityState() {
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (actionSubactivityState == null) {</span>
<span class="nc" id="L540">            actionSubactivityState =</span>
                new RadioAction(
                        new CmdCreateNode(
<span class="nc" id="L543">                                Model.getMetaTypes().getSubactivityState(),</span>
                        &quot;button.new-subactivitystate&quot;));
        }
<span class="nc" id="L546">        return actionSubactivityState;</span>
    }
    /**
     * @return Returns the actionTransition.
     */
    protected Action getActionTransition() {
<span class="nc bnc" id="L552" title="All 2 branches missed.">        if (actionTransition == null) {</span>
<span class="nc" id="L553">            actionTransition =</span>
                new RadioAction(
                        new ActionSetMode(
                                ModeCreatePolyEdge.class,
                                &quot;edgeClass&quot;,
<span class="nc" id="L558">                                Model.getMetaTypes().getTransition(),</span>
                        &quot;button.new-transition&quot;));
        }
<span class="nc" id="L561">        return actionTransition;</span>
    }

    /**
     * @return Returns the actionCallEvent.
     */
    protected Action getActionCallEvent() {
<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (actionCallEvent == null) {</span>
<span class="nc" id="L569">            actionCallEvent = new ButtonActionNewCallEvent();</span>
        }
<span class="nc" id="L571">        return actionCallEvent;</span>
    }

    /**
     * @return Returns the actionCallEvent.
     */
    protected Action getActionChangeEvent() {
<span class="nc bnc" id="L578" title="All 2 branches missed.">        if (actionChangeEvent == null) {</span>
<span class="nc" id="L579">            actionChangeEvent = new ButtonActionNewChangeEvent();</span>
        }
<span class="nc" id="L581">        return actionChangeEvent;</span>
    }

    /**
     * @return Returns the actionCallEvent.
     */
    protected Action getActionSignalEvent() {
<span class="nc bnc" id="L588" title="All 2 branches missed.">        if (actionSignalEvent == null) {</span>
<span class="nc" id="L589">            actionSignalEvent = new ButtonActionNewSignalEvent();</span>
        }
<span class="nc" id="L591">        return actionSignalEvent;</span>
    }

    /**
     * @return Returns the actionCallEvent.
     */
    protected Action getActionTimeEvent() {
<span class="nc bnc" id="L598" title="All 2 branches missed.">        if (actionTimeEvent == null) {</span>
<span class="nc" id="L599">            actionTimeEvent = new ButtonActionNewTimeEvent();</span>
        }
<span class="nc" id="L601">        return actionTimeEvent;</span>
    }

    protected Action getActionGuard() {
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if (actionGuard == null) {</span>
<span class="nc" id="L606">            actionGuard = new ButtonActionNewGuard();</span>
        }
<span class="nc" id="L608">        return actionGuard;</span>
    }

    protected Action getActionCallAction() {
<span class="nc bnc" id="L612" title="All 2 branches missed.">        if (actionCallAction == null) {</span>
<span class="nc" id="L613">            actionCallAction = ActionNewCallAction.getButtonInstance();</span>
        }
<span class="nc" id="L615">        return actionCallAction;</span>
    }

    protected Action getActionCreateAction() {
<span class="nc bnc" id="L619" title="All 2 branches missed.">        if (actionCreateAction == null) {</span>
<span class="nc" id="L620">            actionCreateAction = ActionNewCreateAction.getButtonInstance();</span>
        }
<span class="nc" id="L622">        return actionCreateAction;</span>
    }

    protected Action getActionDestroyAction() {
<span class="nc bnc" id="L626" title="All 2 branches missed.">        if (actionDestroyAction == null) {</span>
<span class="nc" id="L627">            actionDestroyAction = ActionNewDestroyAction.getButtonInstance();</span>
        }
<span class="nc" id="L629">        return actionDestroyAction;</span>
    }

    protected Action getActionReturnAction() {
<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (actionReturnAction == null) {</span>
<span class="nc" id="L634">            actionReturnAction = ActionNewReturnAction.getButtonInstance();</span>
        }
<span class="nc" id="L636">        return actionReturnAction;</span>
    }

    protected Action getActionSendAction() {
<span class="nc bnc" id="L640" title="All 2 branches missed.">        if (actionSendAction == null) {</span>
<span class="nc" id="L641">            actionSendAction = ActionNewSendAction.getButtonInstance();</span>
        }
<span class="nc" id="L643">        return actionSendAction;</span>
    }

    protected Action getActionTerminateAction() {
<span class="nc bnc" id="L647" title="All 2 branches missed.">        if (actionTerminateAction == null) {</span>
<span class="nc" id="L648">            actionTerminateAction =</span>
<span class="nc" id="L649">                ActionNewTerminateAction.getButtonInstance();</span>
        }
<span class="nc" id="L651">        return actionTerminateAction;</span>
    }

    protected Action getActionUninterpretedAction() {
<span class="nc bnc" id="L655" title="All 2 branches missed.">        if (actionUninterpretedAction == null) {</span>
<span class="nc" id="L656">            actionUninterpretedAction =</span>
<span class="nc" id="L657">                ActionNewUninterpretedAction.getButtonInstance();</span>
        }
<span class="nc" id="L659">        return actionUninterpretedAction;</span>
    }

    protected Action getActionActionSequence() {
<span class="nc bnc" id="L663" title="All 2 branches missed.">        if (actionActionSequence == null) {</span>
<span class="nc" id="L664">            actionActionSequence =</span>
<span class="nc" id="L665">                ActionNewActionSequence.getButtonInstance();</span>
        }
<span class="nc" id="L667">        return actionActionSequence;</span>
    }

    /*
     * @see org.argouml.uml.diagram.ui.UMLDiagram#getDependentElement()
     */
    public Object getDependentElement() {
<span class="fc" id="L674">        return getStateMachine(); /* The ActivityGraph. */</span>
    }

    /*
     * @see org.argouml.uml.diagram.ui.UMLDiagram#isRelocationAllowed(java.lang.Object)
     */
    public boolean isRelocationAllowed(Object base) {
<span class="nc" id="L681">        return false;</span>
        /* TODO: We may return the following when the
         * relocate() has been implemented.
         */
//      Model.getActivityGraphsHelper()
//      .isAddingActivityGraphAllowed(base);
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public Collection getRelocationCandidates(Object root) {
        /* TODO: We may return something useful when the
         * relocate() has been implemented. */
<span class="nc" id="L693">        Collection c =  new HashSet();</span>
<span class="nc" id="L694">        c.add(getOwner());</span>
<span class="nc" id="L695">        return c;</span>
    }

    /*
     * @see org.argouml.uml.diagram.ui.UMLDiagram#relocate(java.lang.Object)
     */
    public boolean relocate(Object base) {
<span class="nc" id="L702">        return false;</span>
    }

    /**
     * Once the diagram has loaded we build the previous/next links between
     * any swimlanes.
     */
    @Override
    public void postLoad() {
<span class="fc" id="L711">	FigPartition previous = null;</span>

	// Create a map of partitions keyed by x coordinate
<span class="fc" id="L714">	HashMap map = new HashMap();</span>

<span class="fc" id="L716">	Iterator it = new ArrayList(getLayer().getContents()).iterator();</span>
<span class="fc bfc" id="L717" title="All 2 branches covered.">	while (it.hasNext()) {</span>
<span class="fc" id="L718">	    Fig f = (Fig) it.next();</span>
<span class="pc bpc" id="L719" title="1 of 2 branches missed.">	    if (f instanceof FigPartition) {</span>
<span class="nc" id="L720">		map.put(Integer.valueOf(f.getX()), f);</span>
	    }
<span class="fc" id="L722">	}</span>

	// Sort the x coordinates into order
<span class="fc" id="L725">	List xList = new ArrayList(map.keySet());</span>
<span class="fc" id="L726">        Collections.sort(xList);</span>

        // Link the previous/next reference of the swimlanes
        // according to the x order.
<span class="fc" id="L730">	it = xList.iterator();</span>
<span class="pc bpc" id="L731" title="1 of 2 branches missed.">	while (it.hasNext()) {</span>
<span class="nc" id="L732">	    Fig f = (Fig) map.get(it.next());</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">	    if (f instanceof FigPartition) {</span>
<span class="nc" id="L734">		FigPartition fp = (FigPartition) f;</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">		if (previous != null) {</span>
<span class="nc" id="L736">		    previous.setNextPartition(fp);</span>
		}
<span class="nc" id="L738">		fp.setPreviousPartition(previous);</span>
<span class="nc" id="L739">		fp.setNextPartition(null);</span>
<span class="nc" id="L740">		previous = fp;</span>
	    }
<span class="nc" id="L742">	}</span>
<span class="fc" id="L743">    }</span>

    /**
     * Extends basic functionality to handle logic for enclosement of states
     * within a swimlane.
     * @param enclosed The FigNode enclosed.
     * @param oldEncloser The previous encloser (null if none)
     * @param newEncloser The encloser (null if none)
     */
    public void encloserChanged(
            FigNode enclosed, FigNode oldEncloser, FigNode newEncloser) {

<span class="nc bnc" id="L755" title="All 4 branches missed.">	if (oldEncloser == null &amp;&amp; newEncloser == null) {</span>
<span class="nc" id="L756">	    return;</span>
	}

<span class="nc bnc" id="L759" title="All 4 branches missed.">	if (enclosed instanceof FigStateVertex</span>
		|| enclosed instanceof FigObjectFlowState) {
<span class="nc" id="L761">	    changePartition(enclosed);</span>
	}
<span class="nc" id="L763">    }</span>

    /**
     * Extends basic functionality to handle logic for enclosement of states
     * within a swimlane.
     * @param enclosed The FigNode enclosed.
     */
    private void changePartition(FigNode enclosed) {

<span class="nc bnc" id="L772" title="All 4 branches missed.">	assert enclosed != null;</span>

<span class="nc" id="L774">	Object state = enclosed.getOwner();</span>
<span class="nc" id="L775">	ActivityGraphsHelper activityGraph = Model.getActivityGraphsHelper();</span>

<span class="nc bnc" id="L777" title="All 2 branches missed.">        for (Object f : getLayer().getContentsNoEdges()) {</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">            if (f instanceof FigPartition) {</span>
<span class="nc" id="L779">        	FigPartition fig = (FigPartition) f;</span>
<span class="nc" id="L780">        	Object partition = fig.getOwner();</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">        	if (fig.getBounds().intersects(enclosed.getBounds())) {</span>
<span class="nc" id="L782">                    activityGraph.addContent(partition, state);</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">        	} else if (isStateInPartition(state, partition)) {</span>
<span class="nc" id="L784">                    activityGraph.removeContent(partition, state);</span>
        	}
            }
<span class="nc" id="L787">        }</span>
<span class="nc" id="L788">    }</span>

    private boolean isStateInPartition(Object state, Object partition) {
<span class="nc" id="L791">	return Model.getFacade().getContents(partition).contains(state);</span>
    }

    @Override
    public boolean doesAccept(Object objectToAccept) {
<span class="nc bnc" id="L796" title="All 2 branches missed.">        if (Model.getFacade().isAPartition(objectToAccept)) {</span>
<span class="nc" id="L797">            return true;</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">        } else if (Model.getFacade().isAState(objectToAccept)) {</span>
<span class="nc" id="L799">            return true;</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">        } else if (Model.getFacade().isAPseudostate(objectToAccept)) {</span>
<span class="nc" id="L801">            Object kind = Model.getFacade().getKind(objectToAccept);</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">            if (kind == null) {</span>
<span class="nc" id="L803">                LOG.log(Level.WARNING, &quot;found a null type pseudostate&quot;);</span>
<span class="nc" id="L804">                return false;</span>
            }
<span class="nc bnc" id="L806" title="All 2 branches missed.">            if (kind.equals(</span>
<span class="nc" id="L807">                    Model.getPseudostateKind().getShallowHistory())) {</span>
<span class="nc" id="L808">                return false;</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">            } else if (kind.equals(</span>
<span class="nc" id="L810">                    Model.getPseudostateKind().getDeepHistory())) {</span>
<span class="nc" id="L811">                return false;</span>
            }
<span class="nc" id="L813">            return true;</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">        } else if (Model.getFacade().isAComment(objectToAccept)) {</span>
<span class="nc" id="L815">            return true;</span>
        }
<span class="nc" id="L817">        return false;</span>
    }

    public DiagramElement createDiagramElement(
            final Object modelElement,
            final Rectangle bounds) {

<span class="nc" id="L824">        FigNodeModelElement figNode = null;</span>

<span class="nc" id="L826">        DiagramSettings settings = getDiagramSettings();</span>

<span class="nc bnc" id="L828" title="All 2 branches missed.">        if (Model.getFacade().isAPartition(modelElement)) {</span>
<span class="nc" id="L829">            figNode = new FigPartition(modelElement, bounds, settings);</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">        } else if (Model.getFacade().isAActionState(modelElement)) {</span>
<span class="nc" id="L831">            figNode = new FigActionState(modelElement, bounds, settings);</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">        } else if (Model.getFacade().isACallState(modelElement)) {</span>
<span class="nc" id="L833">            figNode = new FigCallState(modelElement, bounds, settings);</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">        } else if (Model.getFacade().isAObjectFlowState(modelElement)) {</span>
<span class="nc" id="L835">            figNode = new FigObjectFlowState(modelElement, bounds, settings);</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">        } else if (Model.getFacade().isASubactivityState(modelElement)) {</span>
<span class="nc" id="L837">            figNode = new FigSubactivityState(modelElement, bounds, settings);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">        } else if (Model.getFacade().isAFinalState(modelElement)) {</span>
<span class="nc" id="L839">            figNode = new FigFinalState(modelElement, bounds, settings);</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">        } else if (Model.getFacade().isAPseudostate(modelElement)) {</span>
<span class="nc" id="L841">            Object kind = Model.getFacade().getKind(modelElement);</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">            if (kind == null) {</span>
<span class="nc" id="L843">                LOG.log(Level.WARNING, &quot;found a null type pseudostate&quot;);</span>
<span class="nc" id="L844">                return null;</span>
            }
<span class="nc bnc" id="L846" title="All 2 branches missed.">            if (kind.equals(Model.getPseudostateKind().getInitial())) {</span>
<span class="nc" id="L847">                figNode = new FigInitialState(modelElement, bounds, settings);</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">            } else if (kind.equals(</span>
<span class="nc" id="L849">                    Model.getPseudostateKind().getChoice())) {</span>
<span class="nc" id="L850">                figNode = new FigBranchState(modelElement, bounds, settings);</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">            } else if (kind.equals(</span>
<span class="nc" id="L852">                    Model.getPseudostateKind().getJunction())) {</span>
<span class="nc" id="L853">                figNode = new FigJunctionState(modelElement, bounds, settings);</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">            } else if (kind.equals(</span>
<span class="nc" id="L855">                    Model.getPseudostateKind().getFork())) {</span>
<span class="nc" id="L856">                figNode = new FigForkState(modelElement, bounds, settings);</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">            } else if (kind.equals(</span>
<span class="nc" id="L858">                    Model.getPseudostateKind().getJoin())) {</span>
<span class="nc" id="L859">                figNode = new FigJoinState(modelElement, bounds, settings);</span>
            } else {
<span class="nc" id="L861">                LOG.log(Level.WARNING, &quot;found a type not known&quot;);</span>
            }
<span class="nc bnc" id="L863" title="All 2 branches missed.">        } else if (Model.getFacade().isAComment(modelElement)) {</span>
<span class="nc" id="L864">            figNode = new FigComment(modelElement, bounds, settings);</span>
        }

<span class="nc bnc" id="L867" title="All 2 branches missed.">        if (figNode != null) {</span>
<span class="nc" id="L868">            LOG.log(Level.FINE,</span>
                    &quot;Model element {0} converted to {1}&quot;,
                    new Object[]{modelElement, figNode});
        } else {
<span class="nc" id="L872">            LOG.log(Level.FINE, &quot;Dropped object NOT added {0}&quot;, figNode);</span>
        }
<span class="nc" id="L874">        return figNode;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>